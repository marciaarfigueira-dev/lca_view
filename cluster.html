<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ML Sets Report | Clusters</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./pivot.css" />
    <style>
      .scatter {
        position: relative;
        width: 100%;
        height: 420px;
        background: rgba(21, 34, 41, 0.92);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
      }

      .legend {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
        color: var(--muted);
      }

      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
      }

      .tooltip {
        position: absolute;
        pointer-events: none;
        background: rgba(15, 23, 42, 0.95);
        color: #f8fafc;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: var(--shadow);
        font-size: 12px;
        display: none;
        z-index: 10;
        max-width: 240px;
        line-height: 1.4;
      }

      .axis-label-x,
      .axis-label-y {
        position: absolute;
        color: rgba(255, 255, 255, 0.65);
        font-size: 12px;
        pointer-events: none;
      }

      .axis-label-x {
        bottom: 6px;
        left: 50%;
        transform: translateX(-50%);
      }

      .axis-label-y {
        top: 50%;
        left: 6px;
        transform: translateY(-50%) rotate(-90deg);
        transform-origin: left top;
      }

      .layout {
        grid-template-areas:
          "filters stats"
          "dea dea"
          "pivot pivot"
          "detail detail";
      }

      .dea {
        grid-area: dea;
      }

      @media (max-width: 900px) {
        .layout {
          grid-template-areas:
            "filters"
            "stats"
            "dea"
            "pivot"
            "detail";
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="top-bar">
        <div>
          <p class="eyebrow">ML Sets Report</p>
          <h1>Clustering of farmers</h1>
          <p class="lede">
            PCA + hierarchical clustering on four drivers per farmer-season: N rate, pesticide load, yield, and
            mechanisation.
          </p>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
          <a class="ghost" href="./cluster-impacts.html">Cluster impacts</a>
          <a class="ghost" href="./cluster-relative-burden.html">Relative burdens</a>
          <button class="ghost" id="about-btn">About clustering</button>
          <div class="pill">
            <span class="dot"></span>
            <span>HCPC clusters</span>
          </div>
        </div>
      </header>

      <section class="panel" id="about-panel" style="display: none; margin-bottom: 16px">
        <div class="panel-header">
          <div>
            <p class="eyebrow">About</p>
          <h2>How to read the clustering</h2>
        </div>
        <button class="ghost" id="about-close">Close</button>
      </div>
      <div class="stack" style="gap: 12px">
        <div class="panel mini">
          <p class="eyebrow">PC1</p>
          <h3>PC1: Pesticide reliance vs. productive efficiency</h3>
          <p><strong>What it measures:</strong> How much pesticide input is used relative to the yield obtained.</p>
          <ul>
            <li>High PC1 -> high pesticide load and lower yields.</li>
            <li>Low PC1 -> low pesticide load and higher yields.</li>
          </ul>
          <p>
            <strong>Interpretation:</strong> PC1 represents an environmental efficiency gradient. Lower values mean
            more efficient systems (less chemical use per tonne of rice); higher values reflect chemically intensive but
            less productive setups.
          </p>
        </div>
        <div class="panel mini">
          <p class="eyebrow">PC2</p>
          <h3>PC2: Mechanisation and nutrient intensity</h3>
          <p>
            <strong>What it measures:</strong> The level of mechanisation and nitrogen application, and how strongly
            these inputs relate to yield.
          </p>
          <ul>
            <li>High PC2 -> high mechanisation + higher N inputs + generally high yields.</li>
            <li>Low PC2 -> low mechanisation + lower N inputs + lower yields.</li>
          </ul>
          <p>
            <strong>Interpretation:</strong> PC2 captures management intensity - how much machinery and nitrogen a
            system uses, and how effectively those inputs translate into productivity.
          </p>
        </div>
        <div class="panel mini">
          <p class="eyebrow">Clusters</p>
          <h3>Cluster meaning</h3>
          <p>
            Each cluster groups farmer-year observations with similar combinations of pesticide use, nitrogen
            intensity, machinery use, and yield performance. Clusters are management-performance archetypes, not fixed
            farmer identities.
          </p>
          <ul>
            <li>
              <strong>Cluster 1 - Inefficient or stressed systems:</strong> Highest pesticide use and lowest yields;
              chemical pressure high but productivity low; mechanisation and N moderate.
            </li>
            <li>
              <strong>Cluster 2 - High-efficiency systems:</strong> Low nitrogen, very low pesticide, good
              productivity; high resource-use efficiency and likely well-timed management.
            </li>
            <li>
              <strong>Cluster 3 - High-input, high-output regime systems:</strong> Conventional intensive style with
              high nitrogen, high mechanisation, and consistently high yields.
            </li>
          </ul>
        </div>
      </div>
    </section>

    <main class="layout">
      <section class="panel filters">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Filters</p>
              <h2>Scope</h2>
            </div>
            <div class="panel-actions">
              <a class="ghost" href="./bioregional.html">Back</a>
              <button class="ghost" id="reset-filters">Reset</button>
            </div>
          </div>
          <div class="filter-grid">
            <label class="field">
              <span>Season</span>
              <select id="season-filter"></select>
            </label>
            <label class="field">
              <span>Farmer</span>
              <select id="farmer-filter"></select>
            </label>
            <label class="field">
              <span>Cluster</span>
              <select id="cluster-filter"></select>
            </label>
          </div>
          <div class="chip" id="active-filters"></div>
        </section>

        <section class="panel stats">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Overview</p>
              <h2>Clusters</h2>
            </div>
          </div>
          <div class="stat-grid" id="stat-grid"></div>
        </section>

        <section class="panel dea">
          <div class="panel-header">
            <div>
              <p class="eyebrow">DEA</p>
              <h2>Efficiency scores</h2>
            </div>
            <div class="chip muted" id="dea-count"></div>
          </div>
          <div class="stat-grid" id="dea-grid"></div>
        </section>

        <section class="panel pivot">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Projection</p>
              <h2>PCA scatter (PC1 vs PC2)</h2>
            </div>
            <div class="chip muted" id="point-count"></div>
          </div>
          <div id="scatter" class="scatter">
            <div id="tooltip" class="tooltip"></div>
            <div class="axis-label-x">PC1</div>
            <div class="axis-label-y">PC2</div>
          </div>
          <div id="legend" class="legend"></div>
        </section>

        <section class="panel detail">
          <div class="panel-header">
            <div>
              <p class="eyebrow">Detail</p>
              <h2>Farm-year metrics</h2>
            </div>
            <div class="panel-actions">
              <div class="chip muted" id="detail-count"></div>
              <button class="ghost" id="download-csv">Download CSV</button>
            </div>
          </div>
          <div id="detail-table" class="table-shell"></div>
        </section>
      </main>
    </div>

    <script type="module" src="./cluster.js"></script>
  </body>
</html>
